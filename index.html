<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Alarmes Digitais SC2 (Firebase)</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        /* Define a fonte Inter como padrão */
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; }
        /* Estilo para células editáveis */
        .editable-cell {
            min-width: 100px;
            cursor: pointer;
            transition: background-color 0.15s;
            overflow-wrap: break-word;
        }
        .editable-cell:hover {
            background-color: #f3f4f6; /* Cor cinza mais clara ao passar o mouse */
        }
        .data-input {
            width: 100%;
            border: 1px solid #dc2626; /* red-600 */
            padding: 4px;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(220, 38, 38, 0.5);
            outline: none;
        }
        /* Estilo base para os botões de linha (Cinzas) */
        .line-btn {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-600 */
            border: 1px solid #d1d5db; /* gray-300 */
        }
        /* Estilo para o botão de linha ativo/selecionado (Vermelho) */
        .line-btn.active {
            background-color: #dc2626; /* red-600 */
            color: white;
            border-color: #dc2626;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .line-btn:hover:not(.active) {
            background-color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app-container" class="max-w-7xl mx-auto">
        
        <div id="open-in-browser-container" class="mb-4">
            <button id="open-in-browser-btn" class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 transform hover:scale-[1.01] active:scale-[0.98] flex items-center justify-center text-sm md:text-base">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M11 3a1 1 0 100 2h3.586l-7.293 7.293a1 1 0 101.414 1.414L16 6.414V10a1 1 0 102 0V4a1 1 0 00-1-1h-6z" />
                    <path d="M4 12a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H4zm1.5-1A1.5 1.5 0 004 12.5v2a1.5 1.5 0 001.5 1.5h2A1.5 1.5 0 009 14.5v-2A1.5 1.5 0 007.5 11h-2z" fill-rule="evenodd" clip-rule="evenodd" />
                </svg>
                Abrir no Navegador Padrão
            </button>
        </div>

        <header class="mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M3 5a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm6 2a1 1 0 000 2h2a1 1 0 100-2H9zm-1 5a1 1 0 100 2h4a1 1 0 100-2H8z" clip-rule="evenodd" />
                </svg>
                Registro de Alarmes Digitais SC2
            </h1>
            <p class="text-gray-500 text-sm">
                Departamento Técnico - MHK SC2
            </p>
        </header>

        <div class="flex flex-col gap-4 mb-6 items-center justify-between p-4 bg-white rounded-lg shadow-md">
            
            <div id="line-buttons" class="flex flex-wrap gap-2 justify-center sm:justify-start w-full">
                <span class="text-sm font-medium text-gray-700 whitespace-nowrap pt-1">Visualizar Linha:</span>
                <button data-line="Linha 1" class="line-btn px-3 py-1 text-sm font-medium rounded-lg transition duration-150">Linha 1</button>
                <button data-line="Linha 2" class="line-btn px-3 py-1 text-sm font-medium rounded-lg transition duration-150">Linha 2</button>
                <button data-line="Linha 4" class="line-btn px-3 py-1 text-sm font-medium rounded-lg transition duration-150">Linha 4</button>
                <button data-line="Linha 5" class="line-btn px-3 py-1 text-sm font-medium rounded-lg transition duration-150">Linha 5</button>
                <button data-line="Linha 6" class="line-btn px-3 py-1 text-sm font-medium rounded-lg transition duration-150">Linha 6</button>
            </div>

            <div class="flex flex-col sm:flex-row gap-3 w-full justify-between">
                <div class="relative w-full sm:w-1/2">
                    <input type="text" id="search-input" placeholder="Pesquisar em todas as linhas (Código ou Palavra-Chave)" class="w-full p-2 pl-10 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                    <button id="export-csv-btn" class="w-full sm:w-auto px-4 py-2 bg-white text-gray-600 font-semibold rounded-lg border border-gray-300 shadow-sm hover:bg-gray-50 transition duration-150 active:scale-[0.98]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-0.5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        Exportar Tudo (CSV)
                    </button>

                    <button id="add-row-btn" class="w-full sm:w-auto px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 transform hover:scale-[1.02] active:scale-[0.98]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-0.5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Adicionar Registro
                    </button>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto bg-white rounded-xl shadow-2xl">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-100 sticky top-0">
                    <tr>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tl-xl">Linha</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Data</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Código</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider min-w-[250px]">Identificação do Erro</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider min-w-[300px]">Resolução</th>
                        <th scope="col" class="px-3 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider rounded-tr-xl">Ações</th>
                    </tr>
                </thead>
                <tbody id="alarms-table-body" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="6" class="p-4 text-center text-gray-500">Carregando dados...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
            <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-2xl transform transition-all">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-red-700"></h3>
                <p id="modal-message" class="mb-4 text-gray-700"></p>
                <div id="modal-input-container" class="mb-4 hidden">
                    <input type="password" id="modal-password-input" placeholder="Digite a senha" class="data-input w-full">
                    <p id="modal-error-message" class="text-red-500 text-sm mt-1 hidden"></p>
                </div>
                <div id="modal-actions" class="flex justify-end gap-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Confirmar</button>
                </div>
                <button id="modal-close-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition duration-150 hidden">Fechar</button>
            </div>
        </div>

    </div>

    <script>
        // ====================================================================
        // === 1. CONFIGURAÇÃO E VARIÁVEIS GLOBAIS (FIREBASE INCLUÍDO) ===
        // ====================================================================

        // Polyfill simples para crypto.randomUUID (compatibilidade)
        if (typeof crypto.randomUUID !== 'function') {
            crypto.randomUUID = () => (
                ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                )
            );
        }

        // ⚠️ SUBSTITUA ESTES VALORES PELOS SEUS REAIS DO CONSOLE FIREBASE!
        const firebaseConfig = {
            apiKey: "AIzaSyDiTXEU3jZOjsMMiYnM3myOLY7njgx9uQ0",
            authDomain: "quadro-da-qualidade.firebaseapp.com",
            databaseURL: "https://quadro-da-qualidade-default-rtdb.firebaseio.com",
            projectId: "quadro-da-qualidade",
            storageBucket: "quadro-da-qualidade.firebasestorage.app",
            messagingSenderId: "736566707005",
            appId: "1:736566707005:web:f33e4450ea82e375b07b54",
            measurementId: "G-JYGSP8BQW8"
        };

        // Inicializa o app e a referência ao banco de dados
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.database();
        // Referência principal onde todos os dados serão salvos
        const alarmsRef = db.ref('alarms_sc2'); 
        
        // Configurações e variáveis locais
        const EXPORT_PASSWORD = 'admin123';
        // >>> SENHA PARA ADICIONAR E DELETAR REGISTROS (exp321)
        const ADD_PASSWORD = 'exp321'; 
        const LINES = ['Linha 1', 'Linha 2', 'Linha 4', 'Linha 5', 'Linha 6']; 
        
        let alarmsData = [];
        let currentFilter = LINES[0]; 
        let searchTerm = ''; 

        // --- Dados Iniciais (Template de Backup para o caso do Firebase estar vazio) ---
        const initialAlarmsTemplate = [
            { id: crypto.randomUUID(), linha: 'Linha 1', data: '2025-10-28', codigo: 'E 174', identificacao: 'O DSP perdeu conexão - Conexão perdida (ping não OK)', resolucao: 'Trocar a placa interna COREDIGIT', createdAt: new Date().toISOString() },
            { id: crypto.randomUUID(), linha: 'Linha 4', data: '2025-10-23', codigo: 'E59', identificacao: 'Erro do nível de guarda de tinta (Barra X) - Refill Beckhoff', resolucao: 'Trocado o sensor de nível do tanque superior que estava piscando, acusando Overflow.', createdAt: new Date().toISOString() },
            // ... (o restante dos seus dados iniciais de template)
            ...LINES.filter(l => !['Linha 1', 'Linha 4', 'Linha 5'].includes(l)).map(linha => ({ 
                id: crypto.randomUUID(), linha, data: new Date().toISOString().substring(0, 10), 
                codigo: 'NOVO', identificacao: 'Clique para descrever o erro', 
                resolucao: 'Clique para descrever a resolução',
                createdAt: new Date().toISOString()
            }))
        ];


        // ====================================================================
        // === 2. FUNÇÕES FIREBASE (Substituindo LocalStorage) =================
        // ====================================================================

        /**
         * Assina o Realtime Database para carregar dados e manter a sincronia.
         * Esta é a única função de "leitura" e é disparada em toda alteração.
         */
        function loadAndListenForData() {
            alarmsRef.on('value', (snapshot) => {
                const firebaseData = snapshot.val();
                
                // Converte o objeto de dados do Firebase em um Array
                if (firebaseData) {
                    alarmsData = Object.keys(firebaseData).map(key => ({
                        // firebaseId é a chave única para updates e deletes
                        firebaseId: key, 
                        ...firebaseData[key]
                    }));
                    
                    // Ordenação (Mais recente primeiro, usando a data do registro)
                    alarmsData.sort((a, b) => {
                        // Comparação de data (string 'AAAA-MM-DD')
                        if (a.data < b.data) return 1;
                        if (a.data > b.data) return -1;
                        // Critério secundário: data de criação (timestamp)
                        if (a.createdAt < b.createdAt) return 1; 
                        return -1;
                    });

                } else {
                    // Se o banco de dados estiver vazio, usa o template inicial (e salva no Firebase)
                    if (alarmsData.length === 0) {
                        console.log("Banco de dados vazio. Inicializando com template.");
                        initialAlarmsTemplate.forEach(alarm => {
                             // Salva o template no Firebase, gerando IDs
                             alarmsRef.push(alarm);
                        });
                        // Não precisamos de um `else {alarmsData = [];}` aqui, 
                        // pois a próxima chamada do listener (depois do push) vai recarregar.
                        // Mas para evitar um erro visual temporário:
                        alarmsData = initialAlarmsTemplate;
                    } else {
                         alarmsData = [];
                    }
                }
                
                renderTable(); // Re-renderiza a tabela após a atualização do array
            }, (error) => {
                console.error("Erro ao carregar dados do Firebase:", error);
                showModal('Erro de Conexão', 'Não foi possível carregar os dados do Firebase. Verifique sua conexão e regras.', false);
            });
        }


        /**
         * Adiciona um novo registro ao Firebase Realtime Database.
         * É chamada ao clicar no botão 'Adicionar Registro', APÓS a autenticação.
         */
        function addAlarm() {
            const newAlarm = createNewAlarmObject(currentFilter);
            
            // O .push() envia o novo objeto para o Firebase e gera um ID único (firebaseId)
            alarmsRef.push(newAlarm)
                .then(() => {
                    console.log("Novo registro adicionado ao Firebase!");
                    // A tabela será atualizada pelo listener
                    showModal(
                        'Novo Registro Adicionado', 
                        `Um novo registro foi adicionado à Linha ${currentFilter}. Clique em qualquer célula para editá-lo.`,
                        false
                    );
                })
                .catch(error => {
                    console.error("Erro ao adicionar registro:", error);
                    showModal('Erro de Gravação', `Erro ao adicionar registro: ${error.message}`, false);
                });
        }

        /**
         * Atualiza um campo de um registro no Firebase, usando o firebaseId.
         * É chamada ao finalizar a edição de uma célula.
         */
        function updateAlarmField(firebaseId, field, value) {
            
            // Cria um objeto de atualização
            const updates = {};
            updates[field] = value;
            updates.updatedAt = new Date().toISOString(); // Marca a última atualização
            
            // Usa .update() para modificar apenas o campo específico
            alarmsRef.child(firebaseId).update(updates)
                .then(() => {
                    console.log(`Campo ${field} de ${firebaseId} atualizado no Firebase.`);
                })
                .catch(error => {
                    console.error("Erro ao atualizar campo:", error);
                    showModal('Erro de Atualização', `Não foi possível atualizar o dado: ${error.message}`, false);
                });
            // A renderização é feita automaticamente pelo listener 'value'
        }

        // >>> FUNÇÃO DELETAR UM REGISTRO (COM SOLICITAÇÃO DE SENHA)
        function deleteAlarm(firebaseId) {
            // 1. Exibe o modal solicitando a senha
            showModal(
                'Confirmação de Exclusão',
                'Você tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita. Digite a senha para confirmar:',
                false, // Não é confirmação simples
                () => {
                    // 2. Função de Confirmação (executada APÓS a validação da senha)
                    alarmsRef.child(firebaseId).remove()
                        .then(() => {
                            showModal('Excluído', 'O registro foi removido com sucesso.', false);
                        })
                        .catch(error => {
                            console.error("Erro ao deletar registro:", error);
                            showModal('Erro ao Excluir', `Não foi possível deletar o registro: ${error.message}`, false);
                        });
                },
                true, // needsPassword = true
                ADD_PASSWORD // Usa a senha de Adicionar/Deletar: "exp321"
            );
        }

        // ====================================================================
        // === 3. FUNÇÕES MODAL, UTILITÁRIAS E RENDERIZAÇÃO (Adaptadas) =======
        // ====================================================================
        
        // ... (Modal Control Functions: showModal, etc.)
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalActions = document.getElementById('modal-actions');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalInputContainer = document.getElementById('modal-input-container');
        const modalPasswordInput = document.getElementById('modal-password-input');
        const modalErrorMessage = document.getElementById('modal-error-message');

        /**
         * Exibe o modal customizado para confirmação, informação ou entrada de senha.
         * @param {string} title - Título do modal.
         * @param {string} message - Mensagem do corpo do modal.
         * @param {boolean} isConfirm - Se TRUE, mostra botões de Confirmar/Cancelar (usado para confirmações simples sem senha).
         * @param {function} onConfirm - Função a ser executada no clique de Confirmação (ou após validação da senha).
         * @param {boolean} needsPassword - Se TRUE, exige a senha para confirmar.
         * @param {string} requiredPassword - A senha necessária (ex: EXPORT_PASSWORD ou ADD_PASSWORD).
         */
        function showModal(title, message, isConfirm = false, onConfirm = () => {}, needsPassword = false, requiredPassword = EXPORT_PASSWORD) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.add('flex');
            modal.classList.remove('hidden');

            modalPasswordInput.value = '';
            modalErrorMessage.classList.add('hidden');

            if (needsPassword) {
                // Modo de Senha
                modalInputContainer.classList.remove('hidden');
                modalActions.classList.remove('hidden');
                modalCloseBtn.classList.add('hidden');
                modalConfirmBtn.textContent = 'Acessar';

                modalPasswordInput.focus();
                
                // Remove listeners antigos para evitar múltiplas execuções
                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;
                
                modalConfirmBtn.onclick = () => {
                    // Verifica se a senha digitada é a senha REQUERIDA
                    if (modalPasswordInput.value === requiredPassword) {
                        modal.classList.add('hidden');
                        onConfirm(); // Executa a função de sucesso
                    } else {
                        modalErrorMessage.textContent = 'Senha incorreta. Tente novamente.';
                        modalErrorMessage.classList.remove('hidden');
                        modalPasswordInput.value = '';
                        modalPasswordInput.focus();
                    }
                };
                modalCancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                };

            } else if (isConfirm) {
                // Modo de Confirmação Simples
                modalInputContainer.classList.add('hidden');
                modalActions.classList.remove('hidden');
                modalCloseBtn.classList.add('hidden');
                modalConfirmBtn.textContent = 'Confirmar';
                
                // Remove listeners antigos
                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;

                modalConfirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    onConfirm();
                };
                modalCancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                };
            } else {
                // Modo de Informação (apenas botão Fechar)
                modalInputContainer.classList.add('hidden');
                modalActions.classList.add('hidden');
                modalCloseBtn.classList.remove('hidden');
                
                // Remove listeners antigos
                modalCloseBtn.onclick = null;

                modalCloseBtn.onclick = () => modal.classList.add('hidden');
            }
        }
        
        // --- Utility Functions ---

        /**
         * Gera um objeto de dados para um novo registro vazio.
         */
        function createNewAlarmObject(linha) {
            const now = new Date();
            const dateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            return {
                // id: crypto.randomUUID(), // Não é mais necessário, o Firebase gera o ID
                linha: linha,
                data: dateString,
                codigo: 'NOVO',
                identificacao: 'Clique para descrever o erro',
                resolucao: 'Clique para descrever a resolução',
                createdAt: now.toISOString() // Timestamp para ordenação secundária
            };
        }

        /**
         * Função informativa, pois a edição é feita por clique direto na célula.
         */
        function editAlarm(firebaseId) {
             showModal('Modo de Edição', 'Para editar, clique diretamente na célula da tabela que deseja modificar (Linha, Data, Código, Identificação ou Resolução).', false);
        }

        /**
         * Exporta todos os dados para um arquivo CSV, requerendo senha EXPORT_PASSWORD.
         */
        function exportAllToCsv() {
            showModal(
                'Acesso de Exportação', 
                'Para exportar todos os dados, digite a senha de acesso:', 
                false, 
                () => {
                    const data = alarmsData; // Usa todos os dados carregados do Firebase
                    if (data.length === 0) {
                        showModal('Exportação Cancelada', 'Não há dados para exportar.', false);
                        return;
                    }

                    // 1. Define os cabeçalhos do CSV
                    const headers = ['Linha', 'Data', 'Código', 'Identificação do Erro', 'Resolução', 'ID do Firebase', 'Data de Criação', 'Última Atualização'];

                    // 2. Função para escapar strings para CSV
                    const escapeCsv = (str) => {
                        if (str === null || str === undefined) return "";
                        str = String(str).replace(/"/g, '""');
                        if (str.includes(',') || str.includes('\n') || str.includes('"') || str.includes(';')) {
                            return `"${str}"`;
                        }
                        return str;
                    };

                    // 3. Monta o corpo do CSV
                    const rows = data.map(alarm => [
                        escapeCsv(alarm.linha),
                        escapeCsv(alarm.data),
                        escapeCsv(alarm.codigo),
                        escapeCsv(alarm.identificacao),
                        escapeCsv(alarm.resolucao),
                        escapeCsv(alarm.firebaseId),
                        escapeCsv(alarm.createdAt ? new Date(alarm.createdAt).toLocaleString('pt-BR') : ''),
                        escapeCsv(alarm.updatedAt ? new Date(alarm.updatedAt).toLocaleString('pt-BR') : '')
                    ]);

                    // 4. Combina cabeçalhos e linhas
                    const csvContent = [
                        headers.join(';'), // Usando ';' como separador para Excel em PT-BR
                        ...rows.map(row => row.join(';'))
                    ].join('\n');

                    // 5. Cria o Blob e o link de download
                    const blob = new Blob(["\uFEFF", csvContent], { type: 'text/csv;charset=utf-8;' }); // \uFEFF for BOM
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    
                    const date = new Date().toISOString().substring(0, 10);
                    link.setAttribute('download', `registro_alarmes_sc2_${date}.csv`);
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showModal('Exportação Concluída', 'Todos os dados foram exportados com sucesso para um arquivo CSV.', false);

                }, 
                true // isConfirm é true
                , true // needsPassword é true
                , EXPORT_PASSWORD // Senha de Exportação
            );
        }

        // --- Edição e Renderização (Adaptadas para usar 'firebaseId') ---

        /**
         * Inicia a edição de uma célula.
         */
        function startEditing(cell, firebaseId, field, initialValue) { 
            // Verifica se já está em modo de edição
            if (cell.querySelector('input, textarea, select')) return;

            const isLongText = field === 'identificacao' || field === 'resolucao';

            // Cria o campo de entrada
            const input = document.createElement(isLongText ? 'textarea' : 'input');
            input.className = 'data-input';
            input.value = initialValue;

            if (field === 'linha') {
                // Para o campo Linha, usa um <select>
                const select = document.createElement('select');
                select.className = 'data-input';
                LINES.forEach(optionText => {
                    const option = document.createElement('option');
                    option.value = optionText;
                    option.textContent = optionText;
                    if (optionText === initialValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
                
                cell.innerHTML = '';
                cell.appendChild(select);
                select.focus();

                const finishSelectEditing = () => {
                    const newValue = select.value;
                    if (newValue !== initialValue) {
                        updateAlarmField(firebaseId, field, newValue); // Usa firebaseId!
                    }
                    // Restaura o modo de visualização
                    cell.textContent = newValue;
                    setupCellListeners(); // Reanexa listeners
                };

                select.onblur = finishSelectEditing;
                select.onchange = finishSelectEditing; 
                return;

            } else {
                // Para os demais campos, usa input/textarea
                if (field === 'data') {
                    input.type = 'date';
                    // Garante que o input[type="date"] aceite apenas o formato YYYY-MM-DD
                    input.value = initialValue.match(/^\d{4}-\d{2}-\d{2}$/) ? initialValue : '';
                } else if (isLongText) {
                    input.rows = 3;
                    input.style.resize = 'none';
                } else {
                    input.type = 'text';
                }
            }

            // Substitui o conteúdo da célula pelo input
            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();

            // Funções para finalizar a edição
            const finishEditing = () => {
                const newValue = input.value.trim();
                
                if (newValue !== initialValue) {
                    updateAlarmField(firebaseId, field, newValue); // Usa firebaseId!
                }
                
                // Restaura o modo de visualização
                cell.textContent = newValue;
                setupCellListeners(); // Reanexa listeners
            };

            // Eventos para finalizar a edição
            input.onblur = finishEditing; // Salva quando perde o foco
            input.onkeydown = (e) => {
                if (e.key === 'Enter' && !isLongText) {
                    e.preventDefault();
                    finishEditing();
                }
                if (e.key === 'Escape') {
                    // Cancela e reverte para o valor original
                    cell.textContent = initialValue;
                    setupCellListeners(); // Reanexa listeners
                }
            };
        }

        /**
         * Configura os event listeners para as células editáveis após a renderização.
         */
        function setupCellListeners() {
            // Remove listeners antigos (se o elemento for recriado) e reanexa o event delegation.
            document.querySelectorAll('.editable-cell').forEach(cell => {
                cell.onclick = null; 
                // data-alarm-id agora contém o firebaseId
                const firebaseId = cell.getAttribute('data-alarm-id');
                const field = cell.getAttribute('data-field');
                
                cell.onclick = () => {
                    const initialValue = cell.textContent.trim();
                    startEditing(cell, firebaseId, field, initialValue); 
                };
            });
        }


        /**
         * Renderiza a tabela com os dados atuais, aplicando filtro de linha ou pesquisa universal.
         */
        function renderTable() {
            const tableBody = document.getElementById('alarms-table-body');
            const searchLower = searchTerm.toLowerCase();
            const isSearchActive = searchLower.length > 0;
            
            let filteredData = alarmsData;

            if (isSearchActive) {
                // Filtra GLOBALMENTE por termo de pesquisa em todas as colunas
                filteredData = alarmsData.filter(alarm => {
                    const codeMatch = (alarm.codigo || '').toLowerCase().includes(searchLower);
                    const identificationMatch = (alarm.identificacao || '').toLowerCase().includes(searchLower);
                    const resolutionMatch = (alarm.resolucao || '').toLowerCase().includes(searchLower);
                    
                    return codeMatch || identificationMatch || resolutionMatch;
                });
            } else {
                // Filtra apenas pela linha selecionada
                filteredData = alarmsData.filter(alarm => alarm.linha === currentFilter);
            }

            // Garante que o botão da linha correta esteja ativo
            document.querySelectorAll('.line-btn').forEach(btn => {
                if (btn.getAttribute('data-line') === currentFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });


            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-4 text-center text-gray-500">Nenhum registro encontrado ${isSearchActive ? 'para a sua pesquisa' : `para a ${currentFilter}`}.</td>
                    </tr>
                `;
                return;
            }

            // Cria o HTML das linhas
            tableBody.innerHTML = filteredData.map(alarm => `
                <tr class="hover:bg-gray-50 transition duration-100">
                    <td class="px-3 py-2 whitespace-nowrap editable-cell text-sm font-medium text-gray-900" 
                        data-alarm-id="${alarm.firebaseId}" data-field="linha">${alarm.linha}</td>
                    <td class="px-3 py-2 whitespace-nowrap editable-cell text-sm text-gray-500" 
                        data-alarm-id="${alarm.firebaseId}" data-field="data">${alarm.data}</td>
                    <td class="px-3 py-2 whitespace-nowrap editable-cell text-sm font-semibold text-gray-900" 
                        data-alarm-id="${alarm.firebaseId}" data-field="codigo">${alarm.codigo}</td>
                    <td class="px-6 py-2 editable-cell text-sm text-gray-500" 
                        data-alarm-id="${alarm.firebaseId}" data-field="identificacao">${alarm.identificacao}</td>
                    <td class="px-6 py-2 editable-cell text-sm text-gray-500" 
                        data-alarm-id="${alarm.firebaseId}" data-field="resolucao">${alarm.resolucao}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex flex-col gap-1 items-end">
                            <button onclick="deleteAlarm('${alarm.firebaseId}')" class="text-red-600 hover:text-red-900 transition duration-150 p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 100 2v6a1 1 0 102 0V8a1 1 0 00-2 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Reativa os listeners de edição das células
            setupCellListeners();
        }

        // ====================================================================
        // === 4. EVENT LISTENERS GLOBAIS E INICIALIZAÇÃO =====================
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {

            // --- 1. Botões de Filtro de Linha ---
            document.getElementById('line-buttons').addEventListener('click', (e) => {
                if (e.target.matches('.line-btn')) {
                    const newLine = e.target.getAttribute('data-line');
                    if (newLine !== currentFilter) {
                        currentFilter = newLine;
                        // Desativa a pesquisa ao mudar o filtro de linha
                        searchTerm = '';
                        document.getElementById('search-input').value = ''; 
                        renderTable();
                    }
                }
            });

            // --- 2. Campo de Pesquisa ---
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchTerm = e.target.value.trim();
                renderTable();
            });

            // --- 3. Botão Adicionar Registro (Com Senha) ---
            document.getElementById('add-row-btn').addEventListener('click', () => {
                showModal(
                    'Acesso para Adicionar Registro',
                    'Digite a senha para autorizar a adição de um novo registro:',
                    false, // Não é confirmação simples
                    addAlarm, // Função a ser executada após autenticação
                    true, // Requer senha
                    ADD_PASSWORD // A senha necessária: "exp321"
                );
            });

            // --- 4. Botão Exportar CSV (Com Senha) ---
            document.getElementById('export-csv-btn').addEventListener('click', exportAllToCsv);
            
            // --- 5. Botão Abrir no Navegador ---
            document.getElementById('open-in-browser-btn').addEventListener('click', () => {
                window.open(window.location.href, '_system');
            });


            // --- INICIALIZAÇÃO ---
            loadAndListenForData(); 
            
        });
    </script>
</body>
</html>
